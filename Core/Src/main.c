/* USER CODE BEGIN Header */
/**
 ******************************************************************************
 * @file           : main.c
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * <h2><center>&copy; Copyright (c) 2020 STMicroelectronics.
 * All rights reserved.</center></h2>
 *
 * This software component is licensed by ST under BSD 3-Clause license,
 * the "License"; You may not use this file except in compliance with the
 * License. You may obtain a copy of the License at:
 *                        opensource.org/licenses/BSD-3-Clause
 *
 ******************************************************************************
 */
/* USER CODE END Header */

/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "app_x-cube-ai.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "lsm6dsl_reg.h"
#include "arm_math.h"
#include <string.h>
#include <stdio.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */
typedef union {
	int16_t i16bit[3];
	uint8_t u8bit[6];
} axis3bit16_t;
/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define LSM6DSL_INT1_PIN GPIO_PIN_11
#define LSM6DSL_INT1_GPIO_PORT GPIOD
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
CRC_HandleTypeDef hcrc;

DFSDM_Channel_HandleTypeDef hdfsdm1_channel1;

I2C_HandleTypeDef hi2c2;

QSPI_HandleTypeDef hqspi;

SPI_HandleTypeDef hspi3;

UART_HandleTypeDef huart1;
UART_HandleTypeDef huart3;

PCD_HandleTypeDef hpcd_USB_OTG_FS;

/* USER CODE BEGIN PV */
static uint8_t whoamI, rst;
static uint8_t tx_buffer[80];
uint32_t samples = 0;
//static float  x[6660];
//static float  y[6660];
//uint32_t timestamp[6660*3];
static float z[2048];
float32_t slice[2048] = {587.06402,460.18399,389.42401,99.06400,-10.24800,39.04000,-170.80000,-257.17599,-212.27999,-205.93600,-107.84800,34.64799,63.92800,297.67999,237.16799,381.12799,234.72799,311.83200,106.87200,160.55200,-13.66400,-57.58400,24.88800,32.69599,-18.54400,105.89600,408.45599,546.55999,481.65600,457.25601,340.62399,292.80001,127.36800,-134.68800,-115.16799,-305.97601,-224.47999,-218.62400,-299.63198,-105.89600,-149.81599,57.58400,135.17599,72.22399,104.43199,79.54399,-23.91200,-161.04000,-123.95200,-250.34400,-167.87200,22.93600,8.78400,-163.47999,-141.03199,138.10400,390.39999,485.07199,658.31201,518.25598,276.69601,-60.02400,-181.04800,-124.44000,-192.76001,-415.28799,-505.56799,-523.13598,-426.51199,-114.19200,-23.91200,280.11200,386.98400,427.00000,406.99200,230.82400,306.46398,108.33599,146.88800,-61.00000,0.00000,13.17600,-24.88800,251.32000,428.95199,452.37600,678.80798,573.40002,488.97601,338.18399,280.60000,-15.12800,-147.86399,-119.07199,-304.02401,-196.17599,-277.18399,-176.16799,53.19200,163.47999,284.01599,386.49600,330.37600,333.79199,376.73599,101.01599,-20.00799,-44.40800,158.60000,116.14400,254.24800,103.45600,119.55999,395.76800,653.91998,882.30401,814.47198,761.28002,342.08801,80.52000,58.07200,21.96000,-128.83200,-74.17600,-267.91201,-270.35199,-163.47999,152.25599,237.65600,531.43200,477.26400,467.01599,538.26397,345.01599,384.05600,277.67199,168.36000,-54.16799,15.61600,39.04000,134.19999,294.26400,344.04000,470.43200,658.31201,625.12799,514.35199,232.77600,66.36800,34.64799,-95.16000,-310.36801,-245.46400,-399.18399,-380.15200,-310.85601,-93.20800,8.29600,-7.80800,107.84800,193.24800,210.81601,261.08001,131.27200,13.17600,-152.25599,12.20000,40.50400,-130.78399,-89.30400,-112.23999,13.66400,277.18399,540.70397,660.75201,469.94400,403.57601,71.24800,58.56000,-145.42399,-106.87200,-226.43200,-330.37600,-365.02401,-323.05600,-194.71200,-142.00799,163.47999,195.68800,407.48001,412.36001,242.53599,299.14401,69.29599,-50.75199,-163.47999,-118.58400,-251.80799,-181.53599,-48.31200,114.68000,374.78399,330.37600,329.39999,236.19200,85.40000,39.52800,-110.77600,-208.37600,-394.30401,-319.15200,-355.75201,-361.11999,-312.80801,-228.87200,-250.83200,-138.10400,-52.70400,-14.64000,-26.35200,26.84000,-170.80000,-88.32800,-62.95200,4.88000,29.76800,0.97600,-66.36800,-91.25600,7.32000,86.37599,418.21600,366.97601,404.06399,107.84800,-39.52800,9.76000,-138.59199,-172.26400,-105.40800,-293.28799,-192.76001,-276.20800,-67.83200,-47.33600,109.80000,233.26400,312.32000,326.95999,419.67999,233.26400,283.52801,74.17600,127.36800,-40.99200,-34.16000,170.80000,293.28799,435.78399,446.03201,655.87200,647.08801,544.60803,242.53599,179.09600,27.32800,-183.97599,-87.84000,-96.62400,-89.30400,-187.39199,-137.61599,-52.70400,186.41600,196.17599,314.76001,359.16799,429.92800,278.16000,-27.32800,-127.36800,3.90400,-33.18400,160.55200,143.47200,-22.44800,-7.80800,263.51998,508.00799,601.70397,788.60803,658.31201,431.88000,81.98400,61.97600,-132.73600,-185.44000,-116.14400,-286.45599,-285.96801,-81.98400,52.70400,91.74400,404.06399,444.56799,681.24798,592.91998,665.63201,537.77600,245.46400,87.84000,-29.28000,38.55200,40.50400,-23.91200,90.76799,225.45600,507.03201,631.96002,676.36798,487.02401,317.20001,110.77600,48.79999,-78.56800,-255.71200,-288.40799,-196.66400,-196.17599,-284.50399,-75.63999,58.07200,100.52800,380.64001,337.69601,428.95199,285.96801,-16.10400,-135.66400,-143.47200,46.84800,-40.50400,32.20800,-174.70399,-183.48800,-35.62400,219.60000,437.73599,489.46402,352.33599,121.02400,26.35200,-95.16000,-275.23199,-189.83200,-220.08799,-241.55999,-233.75199,-289.38400,-167.38400,-4.39200,286.45599,418.70401,366.97601,362.58401,413.33599,302.55999,169.33599,-61.97600,9.27200,-128.34399,29.28000,-34.16000,172.75199,262.05600,232.77600,319.64001,343.55200,406.99200,256.20001,-54.16799,-94.18399,-202.03199,-379.66400,-413.33599,-428.95199,-429.92800,-407.48001,-219.11200,-111.75199,43.92000,88.81600,222.04000,406.01599,235.70401,123.46400,155.18400,133.22399,170.31199,179.58400,-25.86400,-132.24800,-166.89599,-52.70400,194.71200,447.00799,564.12799,627.56799,321.10400,120.53600,-37.08800,-136.63999,-79.05600,-275.72000,-219.11200,-239.11999,-305.48800,-159.08799,172.26400,411.38400,630.00799,766.64801,787.63201,586.57598,460.67199,427.48800,285.48001,186.41600,138.10400,145.91200,88.81600,200.08000,336.23199,475.80001,577.30401,602.67999,649.03997,358.67999,290.84799,-0.97600,-126.88000,-89.79200,-271.81601,-296.21600,-276.69601,-88.32800,23.42400,165.43200,204.96000,512.88800,626.10400,628.05603,523.13598,234.24000,106.87200,94.18399,263.51998,270.83999,67.34400,53.19200,-145.91200,61.48799,284.01599,505.08001,472.87200,516.30401,306.95199,-37.08800,-184.95199,-250.34400,-267.42401,-271.81601,-288.89599,-310.85601,-289.87200,-81.98400,-34.64799,189.83200,507.03201,629.03198,494.34399,520.20800,247.41600,92.72000,-34.64799,-138.10400,-72.71199,-83.93600,-182.51200,11.22400,130.29600,272.79199,391.86401,436.27200,387.95999,124.44000,-37.57600,-176.16799,-275.23199,-213.25599,-393.32800,-313.78399,-314.76001,-376.24801,-287.92001,-178.11999,-26.84000,259.61599,376.73599,386.98400,293.77600,153.23199,31.72000,-132.24800,15.12800,2.44000,-87.84000,-203.49600,-232.28801,-106.38400,129.32000,242.04800,367.95199,319.64001,270.83999,-60.02400,-104.43199,-198.12800,-218.62400,-225.94400,-388.44799,-319.15200,-354.28799,-425.04800,-118.09600,126.39199,223.01600,345.01599,317.68801,221.55200,114.68000,137.61599,48.31200,-149.32800,-89.30400,-118.09600,-87.35199,-134.19999,-3.41600,256.68798,234.24000,394.30401,190.32000,164.45600,11.22400,-80.52000,-101.99200,-111.75199,-261.08001,-307.44000,-192.76001,-276.20800,-75.15200,31.72000,143.47200,278.16000,382.10400,411.87200,221.06399,97.11200,136.15200,129.32000,186.90400,85.88800,153.72000,-58.56000,49.77600,141.52000,219.60000,541.67999,493.85601,450.91201,424.55999,114.68000,-38.55200,1.95200,-152.25599,-155.18400,-152.25599,-152.25599,-144.93600,43.43199,65.39199,396.74401,481.65600,609.51202,605.60803,484.58401,331.35199,311.83200,174.70399,-48.31200,33.18400,32.69599,-40.50400,178.60800,288.40799,422.11999,533.87200,551.44000,338.67199,302.55999,141.52000,40.50400,-130.78399,-157.13600,-68.80799,-112.23999,-260.59201,-97.59999,-128.83200,-2.92800,303.53601,355.75201,477.75201,625.12799,507.03201,206.91200,81.00800,183.97599,97.59999,104.91999,146.88800,3.90400,-66.36800,8.29600,81.49600,433.83200,561.68798,544.60803,395.27999,87.35199,-58.56000,-131.75999,-150.79200,-170.80000,-64.90399,-95.16000,-104.91999,-170.80000,-9.76000,196.66400,518.25598,641.23199,663.19201,469.94400,334.27999,188.36799,172.75199,58.56000,0.00000,2.92800,32.20800,-38.55200,177.63200,283.04000,248.88000,392.83999,309.88000,174.21600,44.40800,-185.44000,-257.17599,-188.85600,-236.68000,-240.58400,-203.49600,-121.02400,-161.04000,51.72800,154.20800,293.28799,434.32000,340.13601,374.78399,92.72000,-17.56800,-29.76800,141.03199,135.66400,33.18400,-98.57600,-279.13601,-179.58400,154.69599,242.53599,344.04000,393.32800,85.40000,21.96000,-100.52800,-259.12799,-255.71200,-263.03201,-307.92800,-227.89599,-223.01600,-259.61599,55.63200,278.16000,343.55200,450.42401,478.72799,557.29602,325.49600,198.61599,73.20000,-26.35200,44.40800,30.25600,41.96800,-28.79200,185.92800,302.07199,402.11200,434.32000,237.65600,99.06400,-19.03200,21.47200,-173.72799,-251.32000,-310.85601,-200.08000,-276.69601,-167.87200,-46.36000,183.00000,306.46398,351.36001,631.47198,575.35199,631.96002,353.80001,200.56800,261.56799,271.81601,259.12799,67.34400,-40.99200,41.48000,144.44799,242.04800,451.39999,664.65600,466.52801,395.27999,74.17600,-44.40800,56.11999,-39.04000,-34.64799,52.70400,1.46400,-128.83200,-25.37599,306.95199,535.82403,596.82403,698.32800,809.10400,594.87200,451.88800,414.31201,258.15200,145.91200,-34.16000,-59.04800,61.97600,-41.96800,132.73600,101.50399,209.83999,247.90400,187.88000,66.85600,-60.02400,-144.44799,-64.90399,-117.12000,-308.41601,-219.11200,-192.27200,-117.60800,-146.88800,-54.16799,75.15200,227.40800,501.66400,479.21600,441.15200,412.36001,113.70400,133.71200,-26.35200,42.94400,-74.17600,-211.79200,-405.52801,-203.98400,2.44000,107.84800,382.59201,400.16000,307.92800,167.87200,44.89600,-135.66400,-157.62400,-71.73600,-122.48799,-302.55999,-202.52000,-266.93600,22.44800,120.04800,326.47201,455.79199,486.53601,560.71203,435.29599,264.00799,-28.79200,-160.06399,-106.87200,-260.59201,-266.44799,-113.70400,-169.33599,58.56000,161.04000,81.49600,151.27999,47.33600,-156.16000,-77.10400,-115.65599,-300.11999,-246.44000,-433.83200,-426.02401,-234.72799,-290.36001,-96.13600,-132.73600,125.41600,270.83999,240.09600,213.74400,87.84000,-36.60000,24.40000,5.36800,-151.27999,-120.53600,-232.77600,-404.06399,-214.72000,-172.75199,142.49600,253.76001,259.61599,68.80799,-15.61600,49.28800,29.28000,11.22400,-133.71200,-162.99200,-79.05600,-67.34400,7.32000,138.10400,205.44799,509.47201,641.23199,573.40002,643.18402,512.88800,198.12800,141.03199,25.86400,-136.63999,10.24800,48.79999,-42.94400,140.05600,113.70400,204.96000,379.66400,225.45600,268.39999,71.73600,147.37600,-34.64799,14.64000,-159.08799,-149.32800,36.60000,-14.64000,164.45600,85.40000,291.33599,411.87200,543.63201,474.33599,502.64001,210.81601,83.44799,160.55200,177.14399,168.84800,-29.28000,-133.22399,-185.44000,-129.80799,141.52000,298.16799,390.88800,397.23199,203.49600,257.17599,81.49600,173.24000,160.55200,146.40000,-18.05600,48.79999,17.56800,59.53599,183.48800,245.46400,455.30401,610.97601,688.56799,778.84802,630.49603,427.97601,104.43199,-34.64799,17.56800,-143.96000,-155.18400,-138.10400,41.48000,142.98400,259.12799,206.42399,223.01600,204.47200,283.04000,87.84000,-14.64000,4.88000,-71.24800,-91.74400,-183.00000,-141.52000,25.86400,-51.72800,172.26400,224.96800,530.45599,483.60800,538.75201,382.10400,92.23200,-6.83200,-37.57600,48.31200,-161.04000,-260.59201,-295.72799,-94.67200,56.11999,97.11200,198.61599,194.71200,117.60800,137.61599,-59.04800,15.12800,-153.23199,-183.97599,-84.91200,-79.05600,-161.52800,54.65600,186.41600,203.49600,353.31201,473.36001,645.13598,477.75201,349.40799,286.94400,-13.66400,-133.71200,-68.80799,-72.71199,-83.93600,-94.18399,-67.34400,-133.71200,-54.65600,-7.80800,130.29600,-1.46400,-21.47200,-59.53599,-125.41600,-95.16000,-188.36799,-216.18400,-192.27200,-264.49600,-107.36000,-86.86399,-128.34399,178.60800,415.77600,481.16799,660.26397,556.80798,402.11200,273.27999,182.51200,-18.54400,-126.88000,-260.10400,-228.38400,-219.60000,-93.69599,-34.16000,251.80799,220.57600,242.53599,216.67199,288.89599,109.80000,67.83200,150.79200,-27.81600,53.68000,31.72000,-51.72800,80.03199,399.67199,478.72799,754.93603,703.69598,796.41601,671.97601,514.35199,223.99200,105.89600,158.11200,-25.37599,-60.51200,-60.51200,-18.05600,179.09600,117.60800,269.37600,263.51998,260.59201,282.55200,271.32800,71.73600,-41.96800,-140.54400,-158.60000,47.33600,157.62400,88.81600,99.06400,278.64801,428.46402,646.60003,702.23199,708.57598,668.07202,319.64001,251.80799,155.18400,-16.59200,8.78400,-278.64801,-406.99200,-396.74401,-257.17599,52.70400,96.13600,203.49600,218.62400,304.02401,121.02400,81.49600,164.45600,-21.47200,37.57600,-141.03199,-153.72000,17.08000,134.68800,297.19201,351.36001,488.97601,678.32000,662.21600,528.01599,209.83999,153.23199,11.22400,-79.05600,-268.39999,-188.85600,-201.54400,-290.84799,-85.40000,5.85600,-60.51200,-32.69599,-27.81600,-9.76000,-0.97600,-53.68000,-138.59199,-91.25600,-103.94400,-163.96800,47.33600,-50.75199,47.82400,56.60800,167.87200,230.33599,507.52002,517.76800,385.03201,76.12799,44.40800,-153.23199,-175.19200,-117.12000,-215.69599,-424.55999,-433.83200,-210.32800,-178.11999,-28.30400,72.71199,109.80000,72.22399,126.88000,-55.14400,17.56800,-148.35200,-182.02400,-91.74400,-121.02400,-250.34400,-179.58400,-31.72000,279.62399,325.00799,526.06402,371.85601,237.16799,165.91999,-133.22399,-254.24800,-204.96000,-243.02400,-375.27200,-241.07200,-192.76001,-110.28800,-142.00799,-58.07200,133.22399,164.45600,175.19200,150.79200,-46.84800,-133.22399,-86.86399,-103.45600,-179.09600,4.88000,31.23200,31.23200,-52.70400,86.37599,422.60800,471.89599,498.73599,506.05600,203.00799,181.53599,-18.05600,60.51200,-127.36800,-78.08000,-259.12799,-251.32000,-168.84800,-32.69599,120.04800,245.46400,436.76001,318.17599,403.57601,216.18400,280.11200,105.40800,68.80799,154.69599,125.90399,128.83200,181.53599,311.83200,363.07199,647.57598,605.11999,682.71203,520.69598,304.51199,-0.48800,20.98400,-154.69599,-170.31199,-174.21600,-178.11999,-149.81599,28.30400,-26.35200,176.16799,257.17599,214.72000,377.71200,222.04000,120.04800,-14.64000,16.59200,18.05600,-37.57600,149.32800,171.28799,167.38400,88.32800,248.39199,458.23199,609.51202,618.78399,475.31201,383.56799,90.27999,-8.78400,51.72800,-144.93600,-260.10400,-219.60000,-213.74400,-98.08799,-42.45600,274.74398,321.59201,531.91998,546.55999,373.32000,409.43200,207.40000,118.58400,156.16000,-50.75199,14.15200,-129.32000,51.72800,70.27200,378.20001,548.51202,653.91998,648.06402,536.79998,228.87200,175.68000,39.52800,-185.92800,-105.89600,-256.68798,-268.39999,-261.08001,-103.45600,-169.82400,34.16000,124.92800,89.30400,268.88800,115.16799,-6.34400,-162.50399,-251.32000,-103.94400,-137.61599,59.04800,49.28800,5.85600,16.10400,155.67199,403.57601,482.63201,647.57598,506.05600,279.62399,-39.52800,-153.23199,-78.08000,-261.56799,-227.40800,-415.28799,-406.01599,-288.89599,26.35200,81.49600,216.67199,416.26400,400.64801,200.08000,122.48799,161.52800,-56.60800,-159.08799,-116.14400,-273.27999,-110.28800,17.08000,75.63999,388.44799,545.09600,634.88800,642.69598,446.52002,424.07199,115.16799,57.09600,-78.56800,-273.27999,-193.73600,-194.71200,-273.76800,-88.32800,2.92800,-23.91200,76.12799,293.28799,230.33599,213.74400,93.20800,-60.02400,-164.94400,-153.23199,-55.14400,159.57600,165.91999,-2.92800,136.63999,283.04000,549.48797,783.72802,724.67999,587.55200,353.31201,283.52801,159.57600,-24.88800,44.89600,-156.16000,-104.43199,-107.36000,-142.98400,144.93600,209.35200,351.84799,550.46398,448.95999,549.00000,504.10400,318.17599,225.94400,110.77600,-5.85600,-57.09600,-18.54400,92.72000,375.76001,552.90399,579.25598,779.33599,772.50402,683.68798,518.74401,211.30400,161.04000,13.17600,-103.45600,-191.78399,-387.95999,-400.64801,-215.20800,-106.38400,31.23200,168.84800,284.50399,212.76800,189.34400,89.79200,-41.96800,-131.27200,-130.78399,45.38399,-40.99200,58.56000,3.90400,18.05600,164.94400,424.07199,648.55200,601.70397,483.60800,379.17599,154.20800,-142.00799,-111.75199,-300.60800,-378.20001,-318.66400,-329.88800,-406.50399,-284.50399,31.23200,102.48000,248.88000,323.54400,434.32000,249.36799,284.01599,64.90399,-10.73600,38.06399,-141.03199,-150.79200,30.25600,141.52000,290.84799,432.85601,508.00799,526.06402,322.08001,285.96801,-17.56800,-153.72000,-119.07199,-190.80799,-376.73599,-316.71200,-341.11200,-314.27200,-226.43200,-115.16799,-144.93600,-44.89600,157.62400,175.68000,128.34399,36.60000,-174.21600,-183.97599,-139.56800,-126.39199,-74.17600,-302.07199,-194.22399,-75.63999,167.87200,415.28799,515.32800,428.46402,106.87200,39.04000,-91.25600,-284.50399,-198.61599,-383.08001,-323.54400,-349.40799,-434.80801,-193.73600,-149.81599,168.84800,215.20800,432.85601,318.66400,386.98400,292.31201,183.00000,-42.45600,20.00799,-149.81599,-131.75999,-45.38399,86.86399,243.02400,365.51199,450.91201,443.59201,332.81601,289.38400,-12.20000,-156.64799,-102.96800,-124.44000,-262.05600,-124.92800,-105.89600,-65.87999,20.98400,141.52000,273.27999,396.25601,332.81601,421.14401,300.11999,155.67199,-56.60800,-33.18400,181.04800,121.02400,94.67200,127.36800,-32.20800,186.41600,401.62399,489.46402,564.61602,456.76800,376.73599,64.41600,61.97600,-135.66400,-69.29599,-108.82399,-265.47201,-264.00799,-78.56800,18.54400,162.01600,208.37600,372.83200,494.34399,668.07202,633.42401,529.47998,390.88800,117.12000,127.85600,-52.70400,-46.84800,143.96000,255.71200,393.32800,523.62402,489.95199,642.69598,439.20001,385.03201,182.02400,15.61600,-89.79200,-265.95999,-284.50399,-294.26400,-273.27999,-89.79200,20.00799,168.36000,215.20800,370.88000,560.22399,506.05600,226.43200,175.68000,-42.94400,-44.40800,130.78399,151.27999,-42.45600,-132.73600,-138.59199,131.27200,227.89599,536.31201,461.64801,363.55999,191.29600,144.44799,16.59200,-182.02400,-91.74400,-118.09600,-260.59201,-254.73600,-103.45600,-162.50399,-41.96800,251.32000,420.16799,507.03201,508.98400,312.80801,199.10400,89.30400,-14.15200,35.13600,2.92800,10.24800,57.58400,127.85600,92.23200,211.30400,321.59201,502.64001,326.47201,302.55999,-1.46400,-156.16000,-268.88800,-209.35200,-379.17599,-413.82400,-422.60800,-405.04000,-203.98400,-75.15200,-36.11200,265.95999,395.27999,417.23999,193.24800,166.89599,49.28800,4.39200,19.52000,4.88000,-87.35199,-308.41601,-192.27200,-173.72799,108.82399,512.40002,657.33599,634.40002,342.08801,121.51200,-62.46400,-66.36800,-277.67199,-219.60000,-386.98400,-396.74401,-234.72799,-102.48000,-29.76800,197.63999,533.87200,677.34399,591.94403,632.44799,342.08801,288.89599,143.47200,36.11200,-125.90399,20.49600,-55.14400,175.68000,204.47200,501.17599,652.45599,582.18402,656.35998,506.05600,300.11999,133.71200,29.76800,-173.72799,-251.80799,-281.57598,-257.66400,-68.32000,34.16000,160.06399,202.03199,502.64001,497.76001,650.50402,561.68798,399.67199,255.22399,76.61599,113.70400,262.54400,95.16000,128.34399,-34.16000,85.88800,334.76800,588.03997,698.32800,606.58398,502.15200,115.65599,44.89600,-172.26400,-77.59200,-107.84800,-277.67199,-190.32000,-310.85601,-93.20800,-28.79200,205.93600,540.21600,651.96801,632.44799,525.08801,248.88000,96.13600,-20.49600,25.37599,-137.61599,-128.83200,51.72800,130.78399,111.26400,231.31199,316.22399,339.64801,395.76800,123.46400,-53.19200,-68.32000,-279.62399,-224.47999,-398.20800,-426.51199,-416.75201,-235.21600,-283.04000,-176.65600,-55.63200,94.67200,234.72799,428.95199,395.76800,277.67199,183.00000,157.13600,62.95200,72.22399,-9.76000,-170.80000,-271.81601,-92.23200,-17.56800,210.81601,326.47201,418.21600,260.59201,-48.79999,-177.63200,-103.94400,-110.77600,-254.24800,-188.85600,-406.99200,-331.83999,-395.27999,-100.52800,148.35200,232.77600,347.45599,363.55999,401.13601,287.92001,183.48800,-38.55200,-131.75999,-78.56800,-113.21600,-120.53600,-89.30400,-130.29600,-8.29600,112.23999,292.80001,100.52800,57.09600,-113.70400,-227.40800,-390.39999,-380.15200,-386.98400,-412.84799,-405.52801,-208.37600,-112.72800,-134.68800,-8.78400,111.26400,218.13600,244.97599,286.45599,149.32800,39.04000,22.44800,-35.62400,139.56800,-19.03200,17.08000,-158.60000,32.69599,95.64800,429.92800,531.43200,360.14401,187.39199,-16.10400,-157.62400,-87.84000,-67.34400,-148.35200,-136.63999,-154.20800,-164.45600,19.52000,171.77600,386.98400,474.82400,605.60803,750.05603,674.41601,532.40802,230.82400,80.52000,-22.93600,52.70400,-59.04800,-29.28000,139.56800,103.94400,224.47999,341.60000,523.62402,342.08801,197.63999,150.30400,27.32800,-147.37600,-175.19200,-90.76799,-255.22399,-260.59201,-87.84000,-131.27200,-28.30400,259.12799,327.93600,493.36801,674.41601,446.52002,384.54400,107.36000,172.26400,68.32000,88.81600,137.61599,23.42400,-154.20800,51.24000,255.22399,345.99200,466.52801,440.17599,436.27200,264.98400,127.85600,60.51200,29.76800,11.22400,-152.74400,-80.03199,-91.74400,-140.54400,161.52800,388.93600,484.09600,623.17602,788.11999,600.72802,447.49600,392.83999,88.32800,-60.51200,-148.35200,-167.38400,-144.93600,30.25600,-5.36800,123.95200,376.24801,430.90399,400.64801,297.19201,171.77600,-46.84800,-130.29600,-91.25600,-274.25601,-294.75201,-281.57598,-104.91999,-172.26400,30.74399,157.13600,199.10400,349.89599,528.01599,318.17599,251.32000,-50.26400,19.52000,38.55200,46.36000,-145.42399,-255.22399,-291.33599,-66.36800,164.94400,405.04000,523.62402,355.26400,197.15200,128.83200,-139.56800,-89.30400,-118.09600,-270.83999,-295.23999,-188.85600,-297.19201,-179.58400,-0.97600,206.91200,506.05600,462.13601,462.62399,518.74401,246.44000,66.85600,28.30400,-96.13600,-274.74398,-271.32800,-96.62400,-151.27999,60.02400,182.02400,283.52801,192.76001,278.64801,66.36800,-36.11200,9.76000,-162.01600,-97.11200,-280.11200,-293.28799,-250.34400,-170.80000,25.86400,-35.62400,165.91999,299.14401,340.13601,437.24801,532.89599,401.13601,267.91201,90.76799,115.65599,254.24800,165.43200,4.88000,-90.27999,-167.87200,135.17599,237.65600,500.68801,371.36801,398.69601,282.06399,79.54399,177.14399,182.02400,176.65600,126.88000,-62.46400,46.36000,-12.20000,275.72000,343.06399,639.76800,766.16003,804.22399,767.62402,664.16803,505.08001,206.42399,69.29599,-6.83200,-22.93600,130.29600,162.99200,95.16000,308.41601,413.82400,338.67199};
float T[28*28];

float output[4] = {0, 0, 0, 0};


/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DFSDM1_Init(void);
static void MX_I2C2_Init(void);
static void MX_QUADSPI_Init(void);
static void MX_SPI3_Init(void);
static void MX_USART1_UART_Init(void);
static void MX_USART3_UART_Init(void);
static void MX_USB_OTG_FS_PCD_Init(void);
static void MX_CRC_Init(void);
/* USER CODE BEGIN PFP */
static int32_t platform_write(void *handle, uint8_t reg, uint8_t *bufp, uint16_t len);
static int32_t platform_read(void *handle, uint8_t reg, uint8_t *bufp, uint16_t len);
static void tx_com(uint8_t *tx_buffer, uint16_t len);
static int32_t platform_read_int_pin(void);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */
#define FFT_SIZE	1024
/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */
	/*
	 * Initialize mems driver interface
	 */
	stmdev_ctx_t dev_ctx;
	lsm6dsl_int1_route_t int_1_reg;
	dev_ctx.write_reg = platform_write;
	dev_ctx.read_reg = platform_read;
	dev_ctx.handle = &hi2c2;

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DFSDM1_Init();
  MX_I2C2_Init();
  MX_QUADSPI_Init();
  MX_SPI3_Init();
  MX_USART1_UART_Init();
  MX_USART3_UART_Init();
  MX_USB_OTG_FS_PCD_Init();
  MX_CRC_Init();
  MX_X_CUBE_AI_Init();
  /* USER CODE BEGIN 2 */
	/*
	 * Check device ID
	 */
	lsm6dsl_device_id_get(&dev_ctx, &whoamI);
	if (whoamI != LSM6DSL_ID)
		while (1){
			/* manage here device not found */
		}

	/*
	 * Restore default configuration
	 */
	lsm6dsl_reset_set(&dev_ctx, PROPERTY_ENABLE);
	do{
		lsm6dsl_reset_get(&dev_ctx, &rst);
	} while (rst);

	/*
	 * Enable Block Data Update
	 */
	lsm6dsl_block_data_update_set(&dev_ctx, PROPERTY_ENABLE);

	/*
	 * Set full scale
	 */
	lsm6dsl_xl_full_scale_set(&dev_ctx, LSM6DSL_16g);

	/*
	 * Set Output Data Rate
	 */
	lsm6dsl_xl_data_rate_set(&dev_ctx, LSM6DSL_XL_ODR_6k66Hz);

	/*
	 * Enable interrupt generation on DRDY INT1 pin
	 */
	lsm6dsl_pin_int1_route_get(&dev_ctx, &int_1_reg);
	int_1_reg.int1_drdy_xl = PROPERTY_ENABLE;
	lsm6dsl_pin_int1_route_set(&dev_ctx, int_1_reg);


  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
	int8_t z_raw[2];
	while (1)
	{
		uint8_t reg;

		/*
		 * Read LSM6DSL INT pin
		 */

		if (platform_read_int_pin())
		{
			/*
			 * Read status register
			 */
			lsm6dsl_xl_flag_data_ready_get(&dev_ctx, &reg);
			if (reg)
			{
				/* used for debug */
				HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_SET);
				/*
				 * Read accelerometer field data
				 */
				HAL_I2C_Mem_Read(&hi2c2, LSM6DSL_I2C_ADD_L, LSM6DSL_OUTZ_L_XL, I2C_MEMADD_SIZE_8BIT, z_raw, 2, 1000);
				/* convert */
				z[samples] = (((float)((z_raw[1] << 8) + z_raw[0])) *  0.488f);
				samples++;
				HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, GPIO_PIN_RESET);
			}
			/* if one second of samples */
			if (samples > ((2048)-1))
			{
				samples = 0;
				static arm_rfft_fast_instance_f32 fft_instance;
				static float32_t output[FFT_SIZE*2]; //has to be twice FFT size
				static float32_t output2[FFT_SIZE]; //has to be twice FFT size
				arm_rfft_fast_init_f32(&fft_instance, 2048/*bin count*/);

				arm_rfft_fast_f32(&fft_instance, (float32_t*)z, output, 0);
				output[1] = 0;
				arm_cmplx_mag_f32(output, output2, FFT_SIZE);
				for(int i = 0; i < 28*28; i++){
					T[i] = (log2f(output2[i]/(28*28)));
				}
				arm_abs_f32(T, T, 28*28);
				float max = 0;
				int index = 0;
				arm_max_f32(T, 28*28, &max, &index);
				for(int i = 0; i < 28*28; i++){
					T[i] = T[i]/max;
				}
				float cnn_result[4];
				aiRun(T, cnn_result);
				index = 4;
				float confidence = 0;
				for(int i = 0; i < 4; i++){
					if(cnn_result[i] > 0.75){
						index = i;
						confidence = cnn_result[i];
					}
				}
				switch (index){
					case 0:
						sprintf((char *)tx_buffer,
								"Desligado! Confianca - %f\n\r", confidence);
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						break;
					case 1:
						sprintf((char *)tx_buffer,
								"Velocidade 3. Confianca - %f\n\r", confidence);
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						break;
					case 2:
						sprintf((char *)tx_buffer,
								"Velocidade 2. Confianca - %f\n\r", confidence);
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						break;
					case 3:
						sprintf((char *)tx_buffer,
								"Velocidade 1. Confianca - %f\n\r", confidence);
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						break;
					case 4:
						sprintf((char *)tx_buffer,
								"Nao foi possivel decidir. Confiancas - ");
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						for(int i = 0; i < 4; i++){
							sprintf((char *)tx_buffer, "%f ", cnn_result[i]);
							tx_com(tx_buffer, strlen((char const *)tx_buffer));
						}
						sprintf((char *)tx_buffer, "\n\r");
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						break;
					default:
						sprintf((char *)tx_buffer, "???\n\r");
						tx_com(tx_buffer, strlen((char const *)tx_buffer));
						break;
				}
//				HAL_Delay(4000);
			}
		}
	}

    /* USER CODE END WHILE */

//  MX_X_CUBE_AI_Process();
    /* USER CODE BEGIN 3 */
//  sprintf((char *)tx_buffer, "%f,\n\r", o[0]);
//  tx_com(tx_buffer, strlen((char const *)tx_buffer));
//  sprintf((char *)tx_buffer, "%f,\n\r", o[1]);
//	tx_com(tx_buffer, strlen((char const *)tx_buffer));
//	sprintf((char *)tx_buffer, "%f,\n\r", o[2]);
//	tx_com(tx_buffer, strlen((char const *)tx_buffer));
//	sprintf((char *)tx_buffer, "%f,\n\r", o[3]);
//	tx_com(tx_buffer, strlen((char const *)tx_buffer));
//}
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};
  RCC_PeriphCLKInitTypeDef PeriphClkInit = {0};

  /** Configure LSE Drive Capability 
  */
  HAL_PWR_EnableBkUpAccess();
  __HAL_RCC_LSEDRIVE_CONFIG(RCC_LSEDRIVE_LOW);
  /** Initializes the CPU, AHB and APB busses clocks 
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_LSE|RCC_OSCILLATORTYPE_MSI;
  RCC_OscInitStruct.LSEState = RCC_LSE_ON;
  RCC_OscInitStruct.MSIState = RCC_MSI_ON;
  RCC_OscInitStruct.MSICalibrationValue = 0;
  RCC_OscInitStruct.MSIClockRange = RCC_MSIRANGE_6;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_MSI;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 40;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV7;
  RCC_OscInitStruct.PLL.PLLQ = RCC_PLLQ_DIV2;
  RCC_OscInitStruct.PLL.PLLR = RCC_PLLR_DIV2;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
  /** Initializes the CPU, AHB and APB busses clocks 
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_4) != HAL_OK)
  {
    Error_Handler();
  }
  PeriphClkInit.PeriphClockSelection = RCC_PERIPHCLK_USART1|RCC_PERIPHCLK_USART3
                              |RCC_PERIPHCLK_I2C2|RCC_PERIPHCLK_DFSDM1
                              |RCC_PERIPHCLK_USB;
  PeriphClkInit.Usart1ClockSelection = RCC_USART1CLKSOURCE_PCLK2;
  PeriphClkInit.Usart3ClockSelection = RCC_USART3CLKSOURCE_PCLK1;
  PeriphClkInit.I2c2ClockSelection = RCC_I2C2CLKSOURCE_PCLK1;
  PeriphClkInit.Dfsdm1ClockSelection = RCC_DFSDM1CLKSOURCE_PCLK;
  PeriphClkInit.UsbClockSelection = RCC_USBCLKSOURCE_PLLSAI1;
  PeriphClkInit.PLLSAI1.PLLSAI1Source = RCC_PLLSOURCE_MSI;
  PeriphClkInit.PLLSAI1.PLLSAI1M = 1;
  PeriphClkInit.PLLSAI1.PLLSAI1N = 24;
  PeriphClkInit.PLLSAI1.PLLSAI1P = RCC_PLLP_DIV7;
  PeriphClkInit.PLLSAI1.PLLSAI1Q = RCC_PLLQ_DIV2;
  PeriphClkInit.PLLSAI1.PLLSAI1R = RCC_PLLR_DIV2;
  PeriphClkInit.PLLSAI1.PLLSAI1ClockOut = RCC_PLLSAI1_48M2CLK;
  if (HAL_RCCEx_PeriphCLKConfig(&PeriphClkInit) != HAL_OK)
  {
    Error_Handler();
  }
  /** Configure the main internal regulator output voltage 
  */
  if (HAL_PWREx_ControlVoltageScaling(PWR_REGULATOR_VOLTAGE_SCALE1) != HAL_OK)
  {
    Error_Handler();
  }
  /** Enable MSI Auto calibration 
  */
  HAL_RCCEx_EnableMSIPLLMode();
}

/**
  * @brief CRC Initialization Function
  * @param None
  * @retval None
  */
static void MX_CRC_Init(void)
{

  /* USER CODE BEGIN CRC_Init 0 */

  /* USER CODE END CRC_Init 0 */

  /* USER CODE BEGIN CRC_Init 1 */

  /* USER CODE END CRC_Init 1 */
  hcrc.Instance = CRC;
  hcrc.Init.DefaultPolynomialUse = DEFAULT_POLYNOMIAL_ENABLE;
  hcrc.Init.DefaultInitValueUse = DEFAULT_INIT_VALUE_ENABLE;
  hcrc.Init.InputDataInversionMode = CRC_INPUTDATA_INVERSION_NONE;
  hcrc.Init.OutputDataInversionMode = CRC_OUTPUTDATA_INVERSION_DISABLE;
  hcrc.InputDataFormat = CRC_INPUTDATA_FORMAT_BYTES;
  if (HAL_CRC_Init(&hcrc) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN CRC_Init 2 */

  /* USER CODE END CRC_Init 2 */

}

/**
  * @brief DFSDM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_DFSDM1_Init(void)
{

  /* USER CODE BEGIN DFSDM1_Init 0 */

  /* USER CODE END DFSDM1_Init 0 */

  /* USER CODE BEGIN DFSDM1_Init 1 */

  /* USER CODE END DFSDM1_Init 1 */
  hdfsdm1_channel1.Instance = DFSDM1_Channel1;
  hdfsdm1_channel1.Init.OutputClock.Activation = ENABLE;
  hdfsdm1_channel1.Init.OutputClock.Selection = DFSDM_CHANNEL_OUTPUT_CLOCK_SYSTEM;
  hdfsdm1_channel1.Init.OutputClock.Divider = 2;
  hdfsdm1_channel1.Init.Input.Multiplexer = DFSDM_CHANNEL_EXTERNAL_INPUTS;
  hdfsdm1_channel1.Init.Input.DataPacking = DFSDM_CHANNEL_STANDARD_MODE;
  hdfsdm1_channel1.Init.Input.Pins = DFSDM_CHANNEL_FOLLOWING_CHANNEL_PINS;
  hdfsdm1_channel1.Init.SerialInterface.Type = DFSDM_CHANNEL_SPI_RISING;
  hdfsdm1_channel1.Init.SerialInterface.SpiClock = DFSDM_CHANNEL_SPI_CLOCK_INTERNAL;
  hdfsdm1_channel1.Init.Awd.FilterOrder = DFSDM_CHANNEL_FASTSINC_ORDER;
  hdfsdm1_channel1.Init.Awd.Oversampling = 1;
  hdfsdm1_channel1.Init.Offset = 0;
  hdfsdm1_channel1.Init.RightBitShift = 0x00;
  if (HAL_DFSDM_ChannelInit(&hdfsdm1_channel1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN DFSDM1_Init 2 */

  /* USER CODE END DFSDM1_Init 2 */

}

/**
  * @brief I2C2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_I2C2_Init(void)
{

  /* USER CODE BEGIN I2C2_Init 0 */

  /* USER CODE END I2C2_Init 0 */

  /* USER CODE BEGIN I2C2_Init 1 */

  /* USER CODE END I2C2_Init 1 */
  hi2c2.Instance = I2C2;
  hi2c2.Init.Timing = 0x00000E14;
  hi2c2.Init.OwnAddress1 = 0;
  hi2c2.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
  hi2c2.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
  hi2c2.Init.OwnAddress2 = 0;
  hi2c2.Init.OwnAddress2Masks = I2C_OA2_NOMASK;
  hi2c2.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
  hi2c2.Init.NoStretchMode = I2C_NOSTRETCH_DISABLE;
  if (HAL_I2C_Init(&hi2c2) != HAL_OK)
  {
    Error_Handler();
  }
  /** Configure Analogue filter 
  */
  if (HAL_I2CEx_ConfigAnalogFilter(&hi2c2, I2C_ANALOGFILTER_ENABLE) != HAL_OK)
  {
    Error_Handler();
  }
  /** Configure Digital filter 
  */
  if (HAL_I2CEx_ConfigDigitalFilter(&hi2c2, 0) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN I2C2_Init 2 */

  /* USER CODE END I2C2_Init 2 */

}

/**
  * @brief QUADSPI Initialization Function
  * @param None
  * @retval None
  */
static void MX_QUADSPI_Init(void)
{

  /* USER CODE BEGIN QUADSPI_Init 0 */

  /* USER CODE END QUADSPI_Init 0 */

  /* USER CODE BEGIN QUADSPI_Init 1 */

  /* USER CODE END QUADSPI_Init 1 */
  /* QUADSPI parameter configuration*/
  hqspi.Instance = QUADSPI;
  hqspi.Init.ClockPrescaler = 255;
  hqspi.Init.FifoThreshold = 1;
  hqspi.Init.SampleShifting = QSPI_SAMPLE_SHIFTING_NONE;
  hqspi.Init.FlashSize = 1;
  hqspi.Init.ChipSelectHighTime = QSPI_CS_HIGH_TIME_1_CYCLE;
  hqspi.Init.ClockMode = QSPI_CLOCK_MODE_0;
  if (HAL_QSPI_Init(&hqspi) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN QUADSPI_Init 2 */

  /* USER CODE END QUADSPI_Init 2 */

}

/**
  * @brief SPI3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI3_Init(void)
{

  /* USER CODE BEGIN SPI3_Init 0 */

  /* USER CODE END SPI3_Init 0 */

  /* USER CODE BEGIN SPI3_Init 1 */

  /* USER CODE END SPI3_Init 1 */
  /* SPI3 parameter configuration*/
  hspi3.Instance = SPI3;
  hspi3.Init.Mode = SPI_MODE_MASTER;
  hspi3.Init.Direction = SPI_DIRECTION_2LINES;
  hspi3.Init.DataSize = SPI_DATASIZE_4BIT;
  hspi3.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi3.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi3.Init.NSS = SPI_NSS_SOFT;
  hspi3.Init.BaudRatePrescaler = SPI_BAUDRATEPRESCALER_2;
  hspi3.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi3.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi3.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi3.Init.CRCPolynomial = 7;
  hspi3.Init.CRCLength = SPI_CRC_LENGTH_DATASIZE;
  hspi3.Init.NSSPMode = SPI_NSS_PULSE_ENABLE;
  if (HAL_SPI_Init(&hspi3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI3_Init 2 */

  /* USER CODE END SPI3_Init 2 */

}

/**
  * @brief USART1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART1_UART_Init(void)
{

  /* USER CODE BEGIN USART1_Init 0 */

  /* USER CODE END USART1_Init 0 */

  /* USER CODE BEGIN USART1_Init 1 */

  /* USER CODE END USART1_Init 1 */
  huart1.Instance = USART1;
  huart1.Init.BaudRate = 115200;
  huart1.Init.WordLength = UART_WORDLENGTH_8B;
  huart1.Init.StopBits = UART_STOPBITS_1;
  huart1.Init.Parity = UART_PARITY_NONE;
  huart1.Init.Mode = UART_MODE_TX_RX;
  huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart1.Init.OverSampling = UART_OVERSAMPLING_16;
  huart1.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  huart1.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
  if (HAL_UART_Init(&huart1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART1_Init 2 */

  /* USER CODE END USART1_Init 2 */

}

/**
  * @brief USART3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART3_UART_Init(void)
{

  /* USER CODE BEGIN USART3_Init 0 */

  /* USER CODE END USART3_Init 0 */

  /* USER CODE BEGIN USART3_Init 1 */

  /* USER CODE END USART3_Init 1 */
  huart3.Instance = USART3;
  huart3.Init.BaudRate = 115200;
  huart3.Init.WordLength = UART_WORDLENGTH_8B;
  huart3.Init.StopBits = UART_STOPBITS_1;
  huart3.Init.Parity = UART_PARITY_NONE;
  huart3.Init.Mode = UART_MODE_TX_RX;
  huart3.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart3.Init.OverSampling = UART_OVERSAMPLING_16;
  huart3.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  huart3.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
  if (HAL_UART_Init(&huart3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART3_Init 2 */

  /* USER CODE END USART3_Init 2 */

}

/**
  * @brief USB_OTG_FS Initialization Function
  * @param None
  * @retval None
  */
static void MX_USB_OTG_FS_PCD_Init(void)
{

  /* USER CODE BEGIN USB_OTG_FS_Init 0 */

  /* USER CODE END USB_OTG_FS_Init 0 */

  /* USER CODE BEGIN USB_OTG_FS_Init 1 */

  /* USER CODE END USB_OTG_FS_Init 1 */
  hpcd_USB_OTG_FS.Instance = USB_OTG_FS;
  hpcd_USB_OTG_FS.Init.dev_endpoints = 6;
  hpcd_USB_OTG_FS.Init.speed = PCD_SPEED_FULL;
  hpcd_USB_OTG_FS.Init.phy_itface = PCD_PHY_EMBEDDED;
  hpcd_USB_OTG_FS.Init.Sof_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.low_power_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.lpm_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.battery_charging_enable = DISABLE;
  hpcd_USB_OTG_FS.Init.use_dedicated_ep1 = DISABLE;
  hpcd_USB_OTG_FS.Init.vbus_sensing_enable = DISABLE;
  if (HAL_PCD_Init(&hpcd_USB_OTG_FS) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USB_OTG_FS_Init 2 */

  /* USER CODE END USB_OTG_FS_Init 2 */

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOE_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOB_CLK_ENABLE();
  __HAL_RCC_GPIOD_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOE, M24SR64_Y_RF_DISABLE_Pin|M24SR64_Y_GPO_Pin|ISM43362_RST_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOA, ARD_D10_Pin|SPBTLE_RF_RST_Pin|ARD_D9_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOB, ARD_D8_Pin|ISM43362_BOOT0_Pin|ISM43362_WAKEUP_Pin|LED2_Pin 
                          |SPSGRF_915_SDN_Pin|ARD_D5_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOD, USB_OTG_FS_PWR_EN_Pin|PMOD_RESET_Pin|STSAFE_A100_RESET_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(SPBTLE_RF_SPI3_CSN_GPIO_Port, SPBTLE_RF_SPI3_CSN_Pin, GPIO_PIN_SET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOC, VL53L0X_XSHUT_Pin|LED3_WIFI__LED4_BLE_Pin, GPIO_PIN_RESET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(SPSGRF_915_SPI3_CSN_GPIO_Port, SPSGRF_915_SPI3_CSN_Pin, GPIO_PIN_SET);

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(ISM43362_SPI3_CSN_GPIO_Port, ISM43362_SPI3_CSN_Pin, GPIO_PIN_SET);

  /*Configure GPIO pins : M24SR64_Y_RF_DISABLE_Pin M24SR64_Y_GPO_Pin ISM43362_RST_Pin ISM43362_SPI3_CSN_Pin */
  GPIO_InitStruct.Pin = M24SR64_Y_RF_DISABLE_Pin|M24SR64_Y_GPO_Pin|ISM43362_RST_Pin|ISM43362_SPI3_CSN_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOE, &GPIO_InitStruct);

  /*Configure GPIO pins : USB_OTG_FS_OVRCR_EXTI3_Pin SPSGRF_915_GPIO3_EXTI5_Pin SPBTLE_RF_IRQ_EXTI6_Pin ISM43362_DRDY_EXTI1_Pin */
  GPIO_InitStruct.Pin = USB_OTG_FS_OVRCR_EXTI3_Pin|SPSGRF_915_GPIO3_EXTI5_Pin|SPBTLE_RF_IRQ_EXTI6_Pin|ISM43362_DRDY_EXTI1_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOE, &GPIO_InitStruct);

  /*Configure GPIO pin : BUTTON_EXTI13_Pin */
  GPIO_InitStruct.Pin = BUTTON_EXTI13_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_FALLING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(BUTTON_EXTI13_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : ARD_A5_Pin ARD_A4_Pin ARD_A3_Pin ARD_A2_Pin 
                           ARD_A1_Pin ARD_A0_Pin */
  GPIO_InitStruct.Pin = ARD_A5_Pin|ARD_A4_Pin|ARD_A3_Pin|ARD_A2_Pin 
                          |ARD_A1_Pin|ARD_A0_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_ANALOG_ADC_CONTROL;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /*Configure GPIO pins : ARD_D1_Pin ARD_D0_Pin */
  GPIO_InitStruct.Pin = ARD_D1_Pin|ARD_D0_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF8_UART4;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  /*Configure GPIO pins : ARD_D10_Pin SPBTLE_RF_RST_Pin ARD_D9_Pin */
  GPIO_InitStruct.Pin = ARD_D10_Pin|SPBTLE_RF_RST_Pin|ARD_D9_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  /*Configure GPIO pin : ARD_D4_Pin */
  GPIO_InitStruct.Pin = ARD_D4_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF1_TIM2;
  HAL_GPIO_Init(ARD_D4_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : ARD_D7_Pin */
  GPIO_InitStruct.Pin = ARD_D7_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_ANALOG_ADC_CONTROL;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(ARD_D7_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : ARD_D13_Pin ARD_D12_Pin ARD_D11_Pin */
  GPIO_InitStruct.Pin = ARD_D13_Pin|ARD_D12_Pin|ARD_D11_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF5_SPI1;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  /*Configure GPIO pin : ARD_D3_Pin */
  GPIO_InitStruct.Pin = ARD_D3_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(ARD_D3_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pin : ARD_D6_Pin */
  GPIO_InitStruct.Pin = ARD_D6_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_ANALOG_ADC_CONTROL;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(ARD_D6_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : ARD_D8_Pin ISM43362_BOOT0_Pin ISM43362_WAKEUP_Pin LED2_Pin 
                           SPSGRF_915_SDN_Pin ARD_D5_Pin SPSGRF_915_SPI3_CSN_Pin */
  GPIO_InitStruct.Pin = ARD_D8_Pin|ISM43362_BOOT0_Pin|ISM43362_WAKEUP_Pin|LED2_Pin 
                          |SPSGRF_915_SDN_Pin|ARD_D5_Pin|SPSGRF_915_SPI3_CSN_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

  /*Configure GPIO pins : LPS22HB_INT_DRDY_EXTI0_Pin LSM6DSL_INT1_EXTI11_Pin ARD_D2_Pin HTS221_DRDY_EXTI15_Pin 
                           PMOD_IRQ_EXTI12_Pin */
  GPIO_InitStruct.Pin = LPS22HB_INT_DRDY_EXTI0_Pin|LSM6DSL_INT1_EXTI11_Pin|ARD_D2_Pin|HTS221_DRDY_EXTI15_Pin 
                          |PMOD_IRQ_EXTI12_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

  /*Configure GPIO pins : USB_OTG_FS_PWR_EN_Pin SPBTLE_RF_SPI3_CSN_Pin PMOD_RESET_Pin STSAFE_A100_RESET_Pin */
  GPIO_InitStruct.Pin = USB_OTG_FS_PWR_EN_Pin|SPBTLE_RF_SPI3_CSN_Pin|PMOD_RESET_Pin|STSAFE_A100_RESET_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

  /*Configure GPIO pins : VL53L0X_XSHUT_Pin LED3_WIFI__LED4_BLE_Pin */
  GPIO_InitStruct.Pin = VL53L0X_XSHUT_Pin|LED3_WIFI__LED4_BLE_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /*Configure GPIO pins : VL53L0X_GPIO1_EXTI7_Pin LSM3MDL_DRDY_EXTI8_Pin */
  GPIO_InitStruct.Pin = VL53L0X_GPIO1_EXTI7_Pin|LSM3MDL_DRDY_EXTI8_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /*Configure GPIO pin : PMOD_SPI2_SCK_Pin */
  GPIO_InitStruct.Pin = PMOD_SPI2_SCK_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF5_SPI2;
  HAL_GPIO_Init(PMOD_SPI2_SCK_GPIO_Port, &GPIO_InitStruct);

  /*Configure GPIO pins : PMOD_UART2_CTS_Pin PMOD_UART2_RTS_Pin PMOD_UART2_TX_Pin PMOD_UART2_RX_Pin */
  GPIO_InitStruct.Pin = PMOD_UART2_CTS_Pin|PMOD_UART2_RTS_Pin|PMOD_UART2_TX_Pin|PMOD_UART2_RX_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF7_USART2;
  HAL_GPIO_Init(GPIOD, &GPIO_InitStruct);

  /*Configure GPIO pins : ARD_D15_Pin ARD_D14_Pin */
  GPIO_InitStruct.Pin = ARD_D15_Pin|ARD_D14_Pin;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_OD;
  GPIO_InitStruct.Pull = GPIO_PULLUP;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF4_I2C1;
  HAL_GPIO_Init(GPIOB, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI9_5_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI9_5_IRQn);

  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

}

/* USER CODE BEGIN 4 */
/*
 * @brief  Write generic device register (platform dependent)
 *
 * @param  handle    customizable argument. In this examples is used in
 *                   order to select the correct sensor bus handler.
 * @param  reg       register to write
 * @param  bufp      pointer to data to write in register reg
 * @param  len       number of consecutive register to write
 *
 */
static int32_t platform_write(void *handle, uint8_t reg, uint8_t *bufp,
		uint16_t len)
{
	if (handle == &hi2c2)
	{
		HAL_I2C_Mem_Write(handle, LSM6DSL_I2C_ADD_L, reg,
				I2C_MEMADD_SIZE_8BIT, bufp, len, 1000);
	}
	return 0;
}

/*
 * @brief  Read generic device register (platform dependent)
 *
 * @param  handle    customizable argument. In this examples is used in
 *                   order to select the correct sensor bus handler.
 * @param  reg       register to read
 * @param  bufp      pointer to buffer that store the data read
 * @param  len       number of consecutive register to read
 *
 */
static int32_t platform_read(void *handle, uint8_t reg, uint8_t *bufp,
		uint16_t len)
{
	if (handle == &hi2c2)
	{
		HAL_I2C_Mem_Read(handle, LSM6DSL_I2C_ADD_L, reg,
				I2C_MEMADD_SIZE_8BIT, bufp, len, 1000);
	}
	return 0;
}

/*
 * @brief  Write generic device register (platform dependent)
 *
 * @param  tx_buffer     buffer to trasmit
 * @param  len           number of byte to send
 *
 */
static void tx_com(uint8_t *tx_buffer, uint16_t len)
{
	HAL_UART_Transmit(&huart1, tx_buffer, len, 1000);
}

/*
 * @brief  read interrupt pin (platform dependent)
 */
static int32_t platform_read_int_pin(void)
{
	return HAL_GPIO_ReadPin(LSM6DSL_INT1_GPIO_PORT, LSM6DSL_INT1_PIN);
}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
	/* User can add his own implementation to report the HAL error return state */

  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{ 
  /* USER CODE BEGIN 6 */
	/* User can add his own implementation to report the file name and line number,
     tex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
